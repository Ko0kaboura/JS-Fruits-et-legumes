// Variables globales
let config = {};
let products = { fruits: [], legumes: [], herbes: [] };
let cart = [];

// Charger la configuration
async function loadConfig() {
    try {
        const response = await fetch('config.json');
        if (!response.ok) {
            throw new Error(`Erreur lors du chargement de config.json: ${response.status}`);
        }
        config = await response.json();
        console.log('Configuration chargée avec succès:', config);
        return true;
    } catch (error) {
        console.error('Erreur lors du chargement de la configuration:', error);
        return false;
    }
}

// Charger les produits depuis un Google Sheet
async function loadProductsFromSheet() {
    try {
        // Vérifier si l'URL de l'Apps Script est disponible dans la config
        if (!config.googleSheet || !config.googleSheet.scriptUrl) {
            console.warn("URL Google Apps Script non définie dans la configuration");
            return null;
        }
        
        // Utiliser l'URL publiée du script (pas l'URL de l'éditeur)
        const scriptUrl = config.googleSheet.scriptUrl;
        console.log("Tentative de chargement des produits depuis:", scriptUrl);
        
        const response = await fetch(scriptUrl + "?action=getProducts");
        if (!response.ok) {
            throw new Error(`Erreur lors de la réponse du script: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Données reçues du script:", data);
        
        // Vérifier si les données ont la structure attendue
        if (!data.success) {
            throw new Error(data.error || "Format de réponse incorrect");
        }
        
        return data.products || { fruits: [], legumes: [], herbes: [] };
    } catch (error) {
        console.error('Erreur lors du chargement des produits:', error);
        // En cas d'erreur, retourner les données statiques par défaut
        return config.fallbackProducts || products;
    }
}

// Initialisation de l'application
async function initApp() {
    console.log("Initialisation de l'application...");
    
    // 1. Charger la configuration d'abord
    const configLoaded = await loadConfig();
    if (!configLoaded) {
        console.error("Impossible de charger la configuration");
        return;
    }
    
    // 2. Charger les produits depuis la feuille ou utiliser les produits de secours
    try {
        const loadedProducts = await loadProductsFromSheet();
        if (loadedProducts) {
            products = loadedProducts;
            console.log("Produits chargés avec succès:", products);
        } else {
            products = config.fallbackProducts || products;
            console.log("Utilisation des produits de secours:", products);
        }
    } catch (error) {
        console.error("Erreur lors du chargement des produits:", error);
        products = config.fallbackProducts || products;
    }
    
    // 3. Afficher les produits
    displayProducts();
    
    // 4. Autres initialisations
    updateCartCount();
    startCarouselInterval();
}

// Afficher les produits
function displayProducts() {
    console.log("Affichage des produits...");
    
    const fruitsContainer = document.getElementById('fruits-container');
    const legumesContainer = document.getElementById('legumes-container');
    const herbesContainer = document.getElementById('herbes-container');
    
    if (fruitsContainer) {
        // Vider d'abord le conteneur
        fruitsContainer.innerHTML = '';
        
        // Vérifier si nous avons des fruits à afficher
        if (products.fruits && products.fruits.length > 0) {
            console.log(`Affichage de ${products.fruits.length} fruits`);
            products.fruits.forEach(product => {
                fruitsContainer.appendChild(createProductCard(product));
            });
        } else {
            fruitsContainer.innerHTML = '<p>Aucun fruit disponible pour le moment.</p>';
        }
    }
    
    if (legumesContainer) {
        // Vider d'abord le conteneur
        legumesContainer.innerHTML = '';
        
        // Vérifier si nous avons des légumes à afficher
        if (products.legumes && products.legumes.length > 0) {
            console.log(`Affichage de ${products.legumes.length} légumes`);
            products.legumes.forEach(product => {
                legumesContainer.appendChild(createProductCard(product));
            });
        } else {
            legumesContainer.innerHTML = '<p>Aucun légume disponible pour le moment.</p>';
        }
    }
    
    if (herbesContainer) {
        // Vider d'abord le conteneur
        herbesContainer.innerHTML = '';
        
        // Vérifier si nous avons des herbes à afficher
        if (products.herbes && products.herbes.length > 0) {
            console.log(`Affichage de ${products.herbes.length} herbes`);
            products.herbes.forEach(product => {
                herbesContainer.appendChild(createProductCard(product));
            });
        } else {
            herbesContainer.innerHTML = '<p>Aucune herbe disponible pour le moment.</p>';
        }
    }
}

// Créer une carte de produit
function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    // Utiliser une image par défaut si aucune n'est fournie
    const imageUrl = product.image || '/api/placeholder/200/200';
    
    card.innerHTML = `
        <div class="product-image">
            <img src="${imageUrl}" alt="${product.name}">
        </div>
        <div class="product-info">
            <h3 class="product-name">${product.name}</h3>
            <p class="product-price">${(product.price || 0).toFixed(2)} €</p>
            <p class="product-unit">Prix par ${product.unit || 'unité'}</p>
            <button class="add-to-cart" onclick="addToCart('${product.id}', '${product.category}')">Ajouter au panier</button>
        </div>
    `;
    
    return card;
}

// Mettre à jour le compteur du panier
function updateCartCount() {
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        cartCount.textContent = count;
    }
}

// Ajouter un produit au panier
function addToCart(productId, category) {
    // Trouver le produit dans la bonne catégorie
    let product = null;
    if (products[category]) {
        product = products[category].find(p => p.id === productId);
    }
    
    if (product) {
        // Vérifier si le produit est en stock (si la propriété stock existe)
        if (product.hasOwnProperty('stock') && product.stock <= 0) {
            showNotification(`${product.name} est en rupture de stock !`, 'error');
            return;
        }
        
        // Vérifier si le produit est déjà dans le panier
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            // Vérifier si l'augmentation de quantité dépasse le stock disponible
            if (product.hasOwnProperty('stock') && existingItem.quantity + 1 > product.stock) {
                showNotification(`Stock insuffisant pour ${product.name}`, 'error');
                return;
            }
            
            existingItem.quantity += 1;
        } else {
            cart.push({
                ...product,
                quantity: 1
            });
        }
        
        updateCartCount();
        showNotification(`${product.name} ajouté au panier !`, 'success');
    } else {
        console.error(`Produit non trouvé: id=${productId}, catégorie=${category}`);
    }
}

// Afficher notification avec type (success, error)
function showNotification(message, type = 'success') {
    // Créer une notification avec style selon le type
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.bottom = '20px';
    notification.style.right = '20px';
    notification.style.padding = '10px 20px';
    notification.style.borderRadius = '4px';
    notification.style.zIndex = '1001';
    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    
    // Appliquer la couleur selon le type
    if (type === 'error') {
        notification.style.backgroundColor = '#e53935';
    } else {
        notification.style.backgroundColor = 'var(--primary-color)';
    }
    notification.style.color = 'white';
    
    document.body.appendChild(notification);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

// Carousel functions
let currentSlide = 0;
let carouselInterval;
let totalSlides = 0;

function startCarouselInterval() {
    stopCarouselInterval();
    carouselInterval = setInterval(() => {
        moveCarousel(1);
    }, 5000); // Changer de slide toutes les 5 secondes
}

function stopCarouselInterval() {
    if (carouselInterval) {
        clearInterval(carouselInterval);
    }
}

function moveCarousel(direction) {
    const slides = document.querySelectorAll('.carousel-slide');
    totalSlides = slides.length;
    
    if (totalSlides === 0) return;
    
    stopCarouselInterval();
    
    const dots = document.querySelectorAll('.dot');
    
    // Retirer la classe active de la slide actuelle
    slides[currentSlide].classList.remove('active');
    if (dots[currentSlide]) dots[currentSlide].classList.remove('active');
    
    // Calculer la nouvelle slide
    currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
    
    // Ajouter la classe active à la nouvelle slide
    slides[currentSlide].classList.add('active');
    if (dots[currentSlide]) dots[currentSlide].classList.add('active');
    
    startCarouselInterval();
}

function jumpToSlide(slideIndex) {
    const slides = document.querySelectorAll('.carousel-slide');
    totalSlides = slides.length;
    
    if (slideIndex < 0 || slideIndex >= totalSlides) return;
    
    stopCarouselInterval();
    
    const dots = document.querySelectorAll('.dot');
    
    // Retirer la classe active de la slide actuelle
    slides[currentSlide].classList.remove('active');
    if (dots[currentSlide]) dots[currentSlide].classList.remove('active');
    
    // Définir la nouvelle slide
    currentSlide = slideIndex;
    
    // Ajouter la classe active à la nouvelle slide
    slides[currentSlide].classList.add('active');
    if (dots[currentSlide]) dots[currentSlide].classList.add('active');
    
    startCarouselInterval();
}

// Cart modal functions
function openCartModal() {
    const modal = document.getElementById('cartModal');
    if (modal) {
        modal.style.display = 'block';
        updateCartItems();
    }
}

function closeCartModal() {
    const modal = document.getElementById('cartModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function updateCartItems() {
    const cartItemsContainer = document.getElementById('cart-items');
    const cartTotalPrice = document.getElementById('cart-total-price');
    
    if (!cartItemsContainer || !cartTotalPrice) return;
    
    // Vider le conteneur
    cartItemsContainer.innerHTML = '';
    
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = '<tr><td colspan="6" style="text-align: center;">Votre panier est vide</td></tr>';
        cartTotalPrice.textContent = '0.00';
        return;
    }
    
    // Ajouter chaque produit au panier
    let total = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="Produit"><img src="${item.image || '/api/placeholder/60/60'}" alt="${item.name}" class="cart-item-image"></td>
            <td data-label="Nom">${item.name}</td>
            <td data-label="Prix">${item.price.toFixed(2)} €/${item.unit}</td>
            <td data-label="Quantité">
                <div class="quantity-control">
                    <button class="quantity-btn" onclick="updateItemQuantity('${item.id}', ${item.quantity - 1})">-</button>
                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateItemQuantity('${item.id}', this.value)">
                    <button class="quantity-btn" onclick="updateItemQuantity('${item.id}', ${item.quantity + 1})">+</button>
                </div>
            </td>
            <td data-label="Total">${itemTotal.toFixed(2)} €</td>
            <td data-label="Action"><span class="remove-item" onclick="removeFromCart('${item.id}')">❌</span></td>
        `;
        
        cartItemsContainer.appendChild(tr);
    });
    
    cartTotalPrice.textContent = total.toFixed(2);
}

function updateItemQuantity(productId, quantity) {
    const item = cart.find(item => item.id === productId);
    
    if (item) {
        quantity = parseInt(quantity);
        
        if (quantity <= 0) {
            removeFromCart(productId);
        } else {
            item.quantity = quantity;
            updateCartCount();
            updateCartItems();
        }
    }
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    updateCartCount();
    updateCartItems();
}

// Formulaire de commande - validation et soumission
document.addEventListener('DOMContentLoaded', function() {
    // Formulaire de commande
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        // Gestion du checkbox professionnel
        const professionnelCheckbox = document.getElementById('professionnel');
        const livraisonContainer = document.getElementById('livraison-container');
        
        if (professionnelCheckbox && livraisonContainer) {
            professionnelCheckbox.addEventListener('change', function() {
                livraisonContainer.style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Gestion de la date de récupération
        const datePickup = document.getElementById('date-pickup');
        const lieuPickup = document.getElementById('lieu-pickup');
        
        if (datePickup && lieuPickup) {
            // Définir la date minimale (aujourd'hui + 3 jours)
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + 3);
            
            const minDateString = minDate.toISOString().split('T')[0];
            datePickup.setAttribute('min', minDateString);
            
            datePickup.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const dayOfWeek = selectedDate.getDay(); // 0 = dimanche, 1 = lundi, etc.
                
                // Activer le menu déroulant
                lieuPickup.disabled = false;
                lieuPickup.innerHTML = '<option value="">Sélectionnez un lieu</option>';
                
                // Ajouter les options selon le jour
                switch (dayOfWeek) {
                    case 3: // Mercredi
                        lieuPickup.innerHTML += '<option value="enghien">Enghien</option>';
                        break;
                    case 5: // Vendredi
                        lieuPickup.innerHTML += '<option value="lasne">Lasne</option>';
                        break;
                    case 6: // Samedi
                        lieuPickup.innerHTML += '<option value="rixensart">Rixensart</option>';
                        break;
                    case 0: // Dimanche
                        lieuPickup.innerHTML += '<option value="silly">Silly</option>';
                        break;
                    default:
                        lieuPickup.innerHTML = '<option value="">Aucun point de retrait ce jour</option>';
                        lieuPickup.disabled = true;
                }
            });
        }
        
        // Soumission du formulaire
        checkoutForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            if (cart.length === 0) {
                showNotification('Votre panier est vide !', 'error');
                return;
            }
            
            // Validation de base
            const nom = document.getElementById('nom').value.trim();
            const prenom = document.getElementById('prenom').value.trim();
            const telephone = document.getElementById('telephone').value.trim();
            const email = document.getElementById('email').value.trim();
            const datePickup = document.getElementById('date-pickup').value;
            const lieuPickup = document.getElementById('lieu-pickup').value;
            
            // Réinitialiser les messages d'erreur
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
            
            // Validation
            let isValid = true;
            
            if (!nom) {
                document.getElementById('nom-error').textContent = 'Le nom est requis';
                isValid = false;
            }
            
            if (!prenom) {
                document.getElementById('prenom-error').textContent = 'Le prénom est requis';
                isValid = false;
            }
            
            if (!telephone) {
                document.getElementById('telephone-error').textContent = 'Le téléphone est requis';
                isValid = false;
            } else if (!/^\d{10}$/.test(telephone.replace(/\s/g, ''))) {
                document.getElementById('telephone-error').textContent = 'Format de téléphone invalide';
                isValid = false;
            }
            
            if (!email) {
                document.getElementById('email-error').textContent = 'L\'email est requis';
                isValid = false;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('email-error').textContent = 'Format d\'email invalide';
                isValid = false;
            }
            
            if (!datePickup) {
                document.getElementById('date-error').textContent = 'La date de récupération est requise';
                isValid = false;
            }
            
            if (!lieuPickup) {
                document.getElementById('lieu-error').textContent = 'Le lieu de récupération est requis';
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }
            
            // Collecter les données de commande
            const orderItems = cart.map(item => ({
                id: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                total: item.price * item.quantity
            }));
            
            const orderTotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            
            // Données client
            const isProfessionnel = document.getElementById('professionnel').checked;
            const isLivraison = document.getElementById('livraison') ? document.getElementById('livraison').checked : false;
            
            const customerData = {
                nom: nom,
                prenom: prenom,
                telephone: telephone,
                email: email,
                isProfessionnel: isProfessionnel,
                isLivraison: isLivraison,
                dateRetrait: datePickup,
                lieuRetrait: lieuPickup
            };
            
            // Créer l'objet commande
            const orderData = {
                customer: customerData,
                items: orderItems,
                total: orderTotal,
                date: new Date().toISOString(),
                status: 'Nouvelle'
            };
            
            try {
                // Envoyer la commande
                await sendOrderToSheet(orderData);
                
                // Vider le panier
                cart = [];
                updateCartCount();
                closeCartModal();
                
                showNotification('Votre commande a été enregistrée avec succès !', 'success');
                
                // Réinitialiser le formulaire
                checkoutForm.reset();
            } catch (error) {
                console.error('Erreur lors de la commande:', error);
                showNotification('Un problème est survenu lors de la commande. Veuillez réessayer.', 'error');
            }
        });
    }
    
    // Initialiser l'application
    initApp();
});

// Envoyer une commande au Google Sheet
async function sendOrderToSheet(orderData) {
    try {
        // Vérifier si l'URL du script est disponible
        if (!config.googleSheet || !config.googleSheet.scriptUrl) {
            throw new Error('Configuration incomplète: URL du script manquante');
        }
        
        const scriptUrl = config.googleSheet.scriptUrl;
        console.log("Envoi de la commande à:", scriptUrl);
        
        // Mode démo
        if (config.features && config.features.demoMode) {
            console.log('Données de commande (mode démo):', orderData);
            return { success: true, message: 'Commande démo traitée avec succès!' };
        }
        
        // Mode production
        const response = await fetch(scriptUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'submitOrder',
                order: orderData
            })
        });
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erreur inconnue du serveur');
        }
        
        return result;
    } catch (error) {
        console.error('Erreur lors de l\'envoi de la commande:', error);
        throw error;
    }
}

// Fermer le modal en cliquant en dehors
window.onclick = function(event) {
    const modal = document.getElementById('cartModal');
    if (event.target === modal) {
        closeCartModal();
    }
};
